name: Deploy Para Ambiente de Stage Local

on:
  push:
    branches:
      - stage
  pull_request:
    branches:
      - stage
    types: [closed]

jobs:
  deploy-stage:
    if: github.ref == 'refs/heads/stage' || (github.event.pull_request.merged == true && github.base_ref == 'stage')
    runs-on: [self-hosted, stage-runner]
    
    steps:
      - name: Checkout do c√≥digo
        uses: actions/checkout@v4
        
      - name: Build da imagem Docker
        working-directory: ./src
        run: docker build -t app-form-web-stage .
        
      - name: Parar e remover container antigo
        run: |
          docker stop app-form-web-stage || true
          docker rm app-form-web-stage || true
          
      - name: Subir novo container de Stage
        run: |
          docker run -d --restart=always --name app-form-web-stage -p 8080:80 app-form-web-stage:latest
          
      - name: Cleanup imagens antigas
        run: docker image prune -f
