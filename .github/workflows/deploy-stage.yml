# ğŸ§ª PIPELINE DE STAGING - Deploy Para Ambiente de Stage Local
# Este workflow implementa o deploy automatizado para o ambiente de homologaÃ§Ã£o/testes
# Utiliza self-hosted runner local para simular um ambiente de staging

name: (CI/CD) Deploy Para Ambiente de Stage Local

# ğŸ“‹ TRIGGER: Define quando este workflow serÃ¡ executado
# Executa sempre que hÃ¡ um PUSH direto na branch stage
on:
  push:
    branches: [ stage ]       # Monitora pushes na branch stage

jobs:
  # ğŸ§ª JOB PRINCIPAL: ResponsÃ¡vel por todo o processo de deploy em staging
  deploy-stage:
    # âš ï¸ CONDIÃ‡ÃƒO DE SEGURANÃ‡A: Garante que sÃ³ executa em cenÃ¡rios especÃ­ficos
    # SÃ“ executa se for push direto na stage (evita execuÃ§Ãµes desnecessÃ¡rias)
    if: github.ref == 'refs/heads/stage' && github.event_name == 'push'
    
    # ğŸ  RUNNER: Executa em self-hosted runner local (ambiente controlado)
    # Permite simular um ambiente de staging real sem custos de cloud
    runs-on: [self-hosted, stage-runner]
    
    steps:
      # ğŸ” STEP 1: Debug - Mostra informaÃ§Ãµes do contexto para troubleshooting
      - name: Debug
        run: |
          echo "=== STAGE DEPLOY ==="
          echo "Ref: ${{ github.ref }}"
          echo "Event: ${{ github.event_name }}"
          
      # ğŸ“¥ STEP 2: Checkout - Baixa o cÃ³digo fonte do repositÃ³rio
      - name: Checkout do cÃ³digo
        uses: actions/checkout@v4
        
      # ğŸ—ï¸ STEP 3: Build - ConstrÃ³i a imagem Docker da aplicaÃ§Ã£o localmente
      # working-directory especifica onde executar o comando (pasta src)
      - name: Build da imagem Docker
        working-directory: ./src
        run: docker build -t app-form-web-stage .
        
      # ğŸ›‘ STEP 4: Cleanup - Para e remove container antigo para evitar conflitos
      # || true garante que o pipeline nÃ£o falhe se o container nÃ£o existir
      - name: Parar e remover container antigo
        run: |
          docker stop app-form-web-stage || true
          docker rm app-form-web-stage || true
          
      # ğŸš€ STEP 5: Deploy - Inicia o novo container com a versÃ£o atualizada
      # -d: executa em background | --restart=always: reinicia automaticamente
      # -p 8080:80: mapeia porta 8080 do host para porta 80 do container
      - name: Subir novo container de Stage
        run: |
          docker run -d --restart=always --name app-form-web-stage -p 8080:80 app-form-web-stage:latest
          
      # ğŸ§¹ STEP 6: Limpeza - Remove imagens Docker antigas para economizar espaÃ§o
      # -f: forÃ§a a remoÃ§Ã£o sem confirmaÃ§Ã£o
      - name: Cleanup imagens antigas
        run: docker image prune -f
